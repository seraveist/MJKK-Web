{% extends 'base.html' %}
{% block content %}

<div id="loading" class="loading-overlay" style="display: none;">
  <div class="spinner"></div>
</div>

<div class="stats-container">

  <h1>ğŸ€„ ë§ˆìê¹Œê¹Œ ëŒ€ì‹œë³´ë“œ</h1>

  <div class="season-tabs">
    {% for s in available_seasons %}
    <button class="tab {% if s|string == season|string %}active{% endif %}" data-season="{{ s }}">
      ì‹œì¦Œ {{ s }}
    </button>
  {% endfor %}
  <button class="tab {% if season == 'all' %}active{% endif %}" data-season="all">ì „ì²´</button>
  </div>

  <div class="separator"></div>

  <table id="rankingTable">
    <thead>
      <tr>
        <th>ìœ ì €ëª…</th>
        <th>ëŒ€êµ­ ìˆ˜</th>
        <th>ìš°ë§ˆ í•©ì‚°</th>
        <th>ìš°ë§ˆ í‰ê· </th>
      </tr>
    </thead>
    <tbody id="rankingBody"></tbody>
  </table>

  <div class="separator"></div>
  
  <h1>ğŸ“… ë‚ ì§œë³„ ì ìˆ˜ ê¸°ë¡</h1>
  <!-- ë‚ ì§œë³„ ì ìˆ˜ ê¸°ë¡ í…Œì´ë¸” ì˜ì—­ì— vertical scroll ì¶”ê°€ -->
  <div class="table-scroll-wrapper" style="max-height: 400px; overflow-y: auto;">
    <table id="dateScoreTable">
      <thead id="dateScoreHeader">
        <tr><th>ë‚ ì§œ</th></tr>
      </thead>
      <tbody id="dateScoreBody"></tbody>
    </table>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // active íƒ­ ìš”ì†Œë¥¼ ì•ˆì „í•˜ê²Œ ì¡°íšŒ: ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ "all" ì‚¬ìš©
    const activeTabEl = document.querySelector(".season-tabs .tab.active");
    let currentSeason = activeTabEl ? activeTabEl.getAttribute("data-season") : "all";
    let currentPlayer = ""; // index.htmlì—ì„œëŠ” ë­í‚¹ ë°ì´í„° ì¡°íšŒì— í”Œë ˆì´ì–´ ì„ íƒ ì—†ì´ ì²˜ë¦¬

    // íƒ­ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (ì¡°ê±´ë¬¸ ì œê±°)
    const tabs = document.querySelectorAll(".season-tabs .tab");
    tabs.forEach(tab => {
      tab.addEventListener("click", function(){
        tabs.forEach(t => t.classList.remove("active"));
        this.classList.add("active");
        currentSeason = this.getAttribute("data-season");
        loadRanking();  // ë¬´ì¡°ê±´ í˜¸ì¶œ
      });
    });

    function showLoading() {
      const loadingElem = document.getElementById("loading");
      if (loadingElem) {
        loadingElem.style.display = "flex";
      }
    }

    function hideLoading() {
      const loadingElem = document.getElementById("loading");
      if (loadingElem) {
        loadingElem.style.display = "none";
      }
    }

    async function loadRanking() {
      showLoading();
      try {
        const res = await fetch("/ranking?season=" + currentSeason);
        const data = await res.json();

        // ë­í‚¹ í…Œì´ë¸” ì—…ë°ì´íŠ¸
        const rankingTable = document.getElementById("rankingBody");
        if (rankingTable) {
          rankingTable.innerHTML = "";
          data.ranking.forEach(player => {
            const row = document.createElement("tr");
            // í”Œë ˆì´ì–´ ì´ë¦„ í´ë¦­ ì‹œ stats_pageë¡œ ì´ë™í•˜ë„ë¡ ì²˜ë¦¬ (HTML ë Œë”ë§ í˜ì´ì§€)
            row.innerHTML = `
              <td><a href="/stats_page/${player.name}?season=${currentSeason}">${player.name}</a></td>
              <td>${player.games}</td>
              <td>${player.point_sum.toFixed(1)}</td>
              <td>${player.point_avg.toFixed(1)}</td>
            `;
            rankingTable.appendChild(row);
          });
        } else {
          console.error("rankingBody ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }

        // ë‚ ì§œë³„ ì ìˆ˜ ê¸°ë¡ ì—…ë°ì´íŠ¸
        const headerElem = document.getElementById("dateScoreHeader");
        if (headerElem) {
          const headerRow = headerElem.querySelector("tr");
          if (headerRow) {
            headerRow.innerHTML = "<th style='min-width:80px;'>ë‚ ì§œ</th>";
            data.players.forEach(name => {
              const th = document.createElement("th");
              th.textContent = name;
              th.style.minWidth = "80px";
              headerRow.appendChild(th);
            });
          } else {
            console.error("dateScoreHeader ë‚´ë¶€ì— <tr> ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          }
        } else {
          console.error("dateScoreHeader ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }

        const dateScoreBody = document.getElementById("dateScoreBody");
        if (dateScoreBody) {
          dateScoreBody.innerHTML = "";
          data.daily.forEach(entry => {
            const row = document.createElement("tr");
            const dateCell = document.createElement("td");
            dateCell.textContent = entry.date.split("-")[0];
            dateCell.style.minWidth = "80px";
            row.appendChild(dateCell);
            data.players.forEach(name => {
              const td = document.createElement("td");
              td.textContent = entry.points[name] !== undefined ? entry.points[name].toFixed(1) : "-";
              td.style.minWidth = "80px";
              row.appendChild(td);
            });
            dateScoreBody.appendChild(row);
          });
        } else {
          console.error("dateScoreBody ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
      } catch (error) {
        console.error("Error loading ranking:", error);
      } finally {
        hideLoading();
      }
    }

    loadRanking();

  });
</script>


{% endblock %}