{% extends "base.html" %}
{% block content %}
<div id="loading" class="loading-overlay" style="display: none;">
  <div class="spinner"></div>
</div>

<div class="stats-container">
  <h1>ğŸ“‘ ì „ì²´ ìœ ì € í†µê³„</h1>

  <!-- ì‹œì¦Œ íƒ­ -->
  <div class="season-tabs">
    {% for s in available_seasons %}
      <button class="tab {% if s|string == season|string %}active{% endif %}" data-season="{{ s }}">
        ì‹œì¦Œ {{ s }}
      </button>
    {% endfor %}
    <button class="tab {% if season == 'all' %}active{% endif %}" data-season="all">ì „ì²´</button>
  </div>

  <div class="separator"></div>

  <!-- ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ í…Œì´ë¸” ì˜ì—­ -->
  <div class="table-scroll-wrapper" style="max-height:600px;">
    <table id="totalStatsTable">
      <thead>
        <tr id="colHeader">
          <!-- ì²« ë²ˆì§¸ ì…€: í–‰ í—¤ë”ìš© (í•­ëª©) -->
          <th style="position: sticky; left: 0; background-color: #fff; z-index: 11;">í•­ëª©</th>
        </tr>
      </thead>
      <tbody id="totalStatsBody">
      </tbody>
    </table>
  </div>
</div>

<script>
const display_keys = {
    "games": { label: "ëŒ€êµ­ ìˆ˜", format: "int", category: "ê¸°ë³¸" },
    "total.avg": { label: "í‰ê· ìˆœìœ„", format: "float", category: "ê¸°ë³¸" },
    "total_first_count": { label: "1ìœ„ íšŸìˆ˜", format: "int", category: "ê¸°ë³¸" },
    "total_second_count": { label: "2ìœ„ íšŸìˆ˜", format: "int", category: "ê¸°ë³¸" },
    "total_third_count": { label: "3ìœ„ íšŸìˆ˜", format: "int", category: "ê¸°ë³¸" },
    "total_fourth_count": { label: "4ìœ„ íšŸìˆ˜", format: "int", category: "ê¸°ë³¸" },
    "first_rate": { label: "1ìœ„ìœ¨", format: "percent", category: "ê¸°ë³¸" },
    "second_rate": { label: "2ìœ„ìœ¨", format: "percent", category: "ê¸°ë³¸" },
    "third_rate": { label: "3ìœ„ìœ¨", format: "percent", category: "ê¸°ë³¸" },
    "fourth_rate": { label: "4ìœ„ìœ¨", format: "percent", category: "ê¸°ë³¸" },
    "endScore.avg": { label: "ìµœì¢… ì ìˆ˜ í‰ê· ", format: "int", category: "ê¸°ë³¸" },
    "endScore.max": { label: "ìµœì¢… ì ìˆ˜ ìµœê³ ", format: "int", category: "ê¸°ë³¸" },
    "endScore.min": { label: "ìµœì¢… ì ìˆ˜ ìµœì €", format: "int", category: "ê¸°ë³¸" },
    "minusScore.avg": { label: "í† ë¹„ìœ¨", format: "percent", category: "ê¸°ë³¸" },
    "minusOther.avg": { label: "íƒ€ê°€ ë“¤í†µë¥ ", format: "percent", category: "ê¸°ë³¸" },
    "east.avg": { label: "ë™ ì‹œì‘ í‰ê·  ìˆœìœ„", format: "float", category: "ê¸°ë³¸" },
    "south.avg": { label: "ë‚¨ ì‹œì‘ í‰ê·  ìˆœìœ„", format: "float", category: "ê¸°ë³¸" },
    "west.avg": { label: "ì„œ ì‹œì‘ í‰ê·  ìˆœìœ„", format: "float", category: "ê¸°ë³¸" },
    "north.avg": { label: "ë¶ ì‹œì‘ í‰ê·  ìˆœìœ„", format: "float", category: "ê¸°ë³¸" },
    "dora.avg": { label: "í‰ê·  ì „ì²´ ë„ë¼ê°¯ìˆ˜", format: "float", category: "ë„ë¼" },
    "dora_outer.avg": { label: "í‰ê·  ë„ë¼ê°¯ìˆ˜", format: "float", category: "ë„ë¼" },
    "dora_akai.avg": { label: "í‰ê·  ì ë„ë¼ê°¯ìˆ˜", format: "float", category: "ë„ë¼" },
    "dora_inner.avg": { label: "í‰ê·  ë’·ë„ë¼ê°¯ìˆ˜", format: "float", category: "ë„ë¼" },
    "dora.per": { label: "ì „ì²´ ë„ë¼ìœ¨", format: "percent", category: "ë„ë¼" },
    "dora_outer.per": { label: "ì¼ë°˜ ë„ë¼ìœ¨", format: "percent", category: "ë„ë¼" },
    "dora_akai.per": { label: "ì ë„ë¼ìœ¨", format: "percent", category: "ë„ë¼" },
    "dora_inner.per": { label: "ë’·ë„ë¼ìœ¨", format: "percent", category: "ë„ë¼" },
    "dora.max": { label: "ìµœëŒ€ ì „ì²´ ë„ë¼ê°¯ìˆ˜", format: "int", category: "ë„ë¼" },
    "dora_outer.max": { label: "ìµœëŒ€ ë„ë¼ê°¯ìˆ˜", format: "int", category: "ë„ë¼" },
    "dora_akai.max": { label: "ìµœëŒ€ ì ë„ë¼ê°¯ìˆ˜", format: "int", category: "ë„ë¼" },
    "dora_inner.max": { label: "ìµœëŒ€ ë’·ë„ë¼ê°¯ìˆ˜", format: "int", category: "ë„ë¼" },
    "dora_inner_eff.avg": { label: "ë’·ë„ë¼ í‰ê·  ë³€í™”ì ", format: "int", category: "ë„ë¼" },
    "dora_inner_eff.per": { label: "ë’·ë„ë¼ ìœ íš¨ìœ¨", format: "percent", category: "ë„ë¼" },
    "dora_inner_eff.max": { label: "ë’·ë„ë¼ ìµœëŒ€ ë³€í™”ì ", format: "int", category: "ë„ë¼" },
    "winGame.avg": { label: "í™”ë£Œìœ¨", format: "percent", category: "í™”ë£Œ ë° ë°©ì´" },
    "winGame_score.avg": { label: "í‰ê·  íƒ€ì ", format: "int", category: "í™”ë£Œ ë° ë°©ì´" },
    "winGame_host.per": { label: "ì˜¤ì•¼ í™”ë£Œìœ¨", format: "percent", category: "í™”ë£Œ ë° ë°©ì´" },
    "winGame_zimo.per": { label: "ì¯”ëª¨ìœ¨", format: "percent", category: "í™”ë£Œ ë° ë°©ì´" },
    "winGame_dama.per": { label: "ë‹¤ë§ˆìœ¨", format: "percent", category: "í™”ë£Œ ë° ë°©ì´" },
    "winGame_round.avg": { label: "í‰ê·  í™”ë£Œ ìˆœìˆ˜", format: "float", category: "í™”ë£Œ ë° ë°©ì´" },
    "chong.avg": { label: "ë°©ì´ë¥ ", format: "percent", category: "í™”ë£Œ ë° ë°©ì´" },
    "chong_score.avg": { label: "í‰ê·  ë°©ì´", format: "int", category: "í™”ë£Œ ë° ë°©ì´" },
    "chong_host.per": { label: "ë°©ì´ì‹œ ì˜¤ì•¼ìœ¨", format: "percent", category: "í™”ë£Œ ë° ë°©ì´" },
    "chong_fulu.per": { label: "ë°©ì´ì‹œ í›„ë¡œìœ¨", format: "percent", category: "í™”ë£Œ ë° ë°©ì´" },
    "chong_richi.per": { label: "ë°©ì´ì‹œ ë¦¬ì¹˜ìœ¨", format: "percent", category: "í™”ë£Œ ë° ë°©ì´" },
    "dehost.avg": { label: "ì˜¤ì•¼ì¹´ë¶€ë¦¬ìœ¨", format: "percent", category: "í™”ë£Œ ë° ë°©ì´" },
    "dehost_score.avg": { label: "ì˜¤ì•¼ì¹´ë¶€ë¦¬ í‰ê· ", format: "int", category: "í™”ë£Œ ë° ë°©ì´" },
    "otherZimo.avg": { label: "í”¼ì¯”ëª¨ìœ¨", format: "percent", category: "í™”ë£Œ ë° ë°©ì´" },
    "richi.avg": { label: "ë¦¬ì¹˜ìœ¨", format: "percent", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" },
    "richi_winGame.per": { label: "ë¦¬ì¹˜ ì„±ê³µë¥ ", format: "percent", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" },
    "richi_score.avg": { label: "ë¦¬ì¹˜ ìˆ˜ì§€", format: "int", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" },
    "richi_yifa.per": { label: "ì¼ë°œë¥ ", format: "percent", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" },
    "richi_rong.per": { label: "ë¦¬ì¹˜ì‹œ ë¡ ë¥ ", format: "percent", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" },
    "richi_zimo.per": { label: "ë¦¬ì¹˜ì‹œ ì¯”ëª¨ìœ¨", format: "percent", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" },
    "richi_chong.per": { label: "ë¦¬ì¹˜ì‹œ ë°©ì´ë¥ ", format: "percent", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" },
    "richi_draw.per": { label: "ë¦¬ì¹˜ì‹œ ìœ êµ­ë¥ ", format: "percent", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" },
    "richi_otherZimo.per": { label: "ë¦¬ì¹˜ì‹œ íƒ€ê°€ ì¯”ëª¨ìœ¨", format: "percent", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" },
    "richi_machi.per": { label: "ë¦¬ì¹˜ ë‹¤ë©´ìœ¨", format: "percent", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" },
    "richi_first.per": { label: "ë¦¬ì¹˜ ì„ ì œìœ¨", format: "percent", category: "ë¦¬ì¹˜ ë° í›„ë¡œ"  },
    "fulu.avg": { label: "í›„ë¡œìœ¨", format: "percent", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" },
    "fulu_score.avg": { label: "í›„ë¡œ ìˆ˜ì§€", format: "int", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" },
    "fulu_zimo.per": { label: "í›„ë¡œì‹œ ì¯”ëª¨ìœ¨", format: "percent", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" },
    "fulu_rong.per": { label: "í›„ë¡œì‹œ ë¡ ìœ¨", format: "percent", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" },
    "fulu_chong.per": { label: "í›„ë¡œì‹œ ë°©ì´ë¥ ", format: "percent", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" }
    };

let currentSeason = "{{ season }}";
let allPlayers = [];
let userStats = {};  // ê° ìœ ì €ë³„ í†µê³„ë¥¼ ì €ì¥. ì˜ˆ: userStats["HorTeNsiA"] = {games: 10, ...};

// ì‹œì¦Œ íƒ­ í´ë¦­ ì‹œ ë™ì‘
document.querySelectorAll(".season-tabs .tab").forEach(tab => {
  tab.addEventListener("click", () => {
    document.querySelectorAll(".season-tabs .tab").forEach(t => t.classList.remove("active"));
    tab.classList.add("active");
    currentSeason = tab.getAttribute("data-season");
    // í…Œì´ë¸” ì¬ë¹Œë“œ
    document.getElementById("colHeader").innerHTML = 
      "<th style='position: sticky; left: 0; background-color: #fff; z-index: 11;'>í•­ëª©</th>";
    document.getElementById("totalStatsBody").innerHTML = "";
    loadTotalStats();
  });
});

// í˜ì´ì§€ ë¡œë“œ ì‹œì 
document.addEventListener("DOMContentLoaded", () => {
  loadTotalStats();
});

// ì „ì²´ ë¡œë”© ë¡œì§
function loadTotalStats() {
  showLoading();
  // 1) allPlayers ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
  fetch("/stats/all")
    .then(res => res.json())
    .then(data => {
      allPlayers = data.allPlayers || [];
      return fetchAllPlayersStats();
      console.log("user stats :", userStats)
      console.log("players : " , allPlayers)
    })
    .then(() => {
      buildTable();
    })
    .catch(err => console.error("Error in loadTotalStats:", err))
    .finally(() => hideLoading());
}

// ìœ ì €ë³„ stats_api ë¶ˆëŸ¬ì˜¤ê¸°
async function fetchAllPlayersStats() {
  userStats = {};  // ì´ˆê¸°í™”
  // Promise.all í˜•íƒœë¡œ ìœ ì €ë³„ ìš”ì²­
  const promises = allPlayers.map(player => {
  return fetch(`/stats_api/${player}?season=${currentSeason}`)
    .then(res => res.json())
    .then(data => {
      if (data && data.stats) {
        const totalGames = data.stats.games || 0;
        if (totalGames > 0) {
          data.stats.first_rate = data.stats.total_first_count / totalGames;
          data.stats.second_rate = data.stats.total_second_count / totalGames;
          data.stats.third_rate = data.stats.total_third_count / totalGames;
          data.stats.fourth_rate = data.stats.total_fourth_count / totalGames;
          userStats[player] = data.stats;
        } else {
          // totalGamesê°€ 0ì´ë©´, í•´ë‹¹ ìœ ì € ë°ì´í„°ëŠ” userStatsì— ë„£ì§€ ì•ŠìŒ
          userStats[player] = null;
        }
      } else {
        // ì—ëŸ¬ ìƒí™©ì´ê±°ë‚˜ ë°ì´í„°ê°€ ì—†ìŒ
        userStats[player] = null;
      }
    })
    .catch(error => {
      console.error(`Error fetching stats for player ${player}:`, error);
      userStats[player] = null;
    });
});
await Promise.all(promises);

// allPlayers ë°°ì—´ì—ì„œ userStats[player]ê°€ nullì´ ì•„ë‹Œ ìœ ì €ë§Œ í•„í„°ë§
allPlayers = allPlayers.filter(player => userStats[player] !== null);
}

// í…Œì´ë¸” ë¹Œë“œ
function buildTable() {
  // 1) í…Œì´ë¸” í—¤ë”(ì—´ í—¤ë”) êµ¬ì„±
  const headerRow = document.getElementById("colHeader");
  allPlayers.forEach(player => {
    const th = document.createElement("th");
    th.textContent = player;
    // sticky ì²˜ë¦¬ (ìƒë‹¨ í—¤ë”)
    th.style.position = "sticky";
    th.style.top = "0";
    th.style.backgroundColor = "#fff";
    th.style.zIndex = "10";
    headerRow.appendChild(th);
  });

  // 2) í…Œì´ë¸” ë°”ë”” êµ¬ì„±
  const tableBody = document.getElementById("totalStatsBody");
  tableBody.innerHTML = "";

  for (const key in display_keys) {
    const { label, format } = display_keys[key];
    const row = document.createElement("tr");

    // í–‰ í—¤ë” (display_keys ë¼ë²¨)
    const th = document.createElement("th");
    th.textContent = label;
    // ì™¼ìª½ ì²« ì—´ sticky
    th.style.position = "sticky";
    th.style.left = "0";
    th.style.backgroundColor = "#fff";
    th.style.zIndex = "5";
    row.appendChild(th);

    // ì´ì œ ê° í”Œë ˆì´ì–´ì— ëŒ€í•´, userStats[player][key] ê°’ì„ í‘œì‹œ
    allPlayers.forEach(player => {
      const td = document.createElement("td");
      let rawValue = key.split('.').reduce((o, i) => (o ? o[i] : undefined), userStats[player] || {});
      // ìˆ«ìë¡œ ë³€í™˜
      if (typeof rawValue === "number") {
        rawValue = formatValue(rawValue, format);
      } else if (rawValue === undefined || rawValue === null) {
        rawValue = "-";
      }
      td.textContent = rawValue;
      row.appendChild(td);
    });

    tableBody.appendChild(row);
  }
}

// ê°’ í¬ë§·íŒ… í•¨ìˆ˜
function formatValue(value, format) {
  if (isNaN(value)) return "-";
  switch (format) {
    case "int":
      return Math.floor(value).toLocaleString();
    case "float":
      return value.toFixed(1);
    case "percent":
      return (value * 100).toFixed(1) + "%";
    default:
      return value.toString();
  }
}

function showLoading() {
  document.getElementById("loading").style.display = "flex";
}
function hideLoading() {
  document.getElementById("loading").style.display = "none";
}
</script>
{% endblock %}