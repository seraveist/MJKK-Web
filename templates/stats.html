{% extends "base.html" %}
{% block content %}

<div id="loading" class="loading-overlay" style="display: none;">
  <div class="spinner"></div>
</div>

<div class="stats-container">
  <h1>ğŸ“‘ ë§ˆìê¹Œê¹Œ ê°œì¸ í†µê³„</h1>
  <div class="season-tabs">
    {% for s in available_seasons %}
      <button class="tab {% if s|string == season|string %}active{% endif %}" data-season="{{ s }}">
        ì‹œì¦Œ {{ s }}
      </button>
    {% endfor %}
    <button class="tab {% if season == 'all' %}active{% endif %}" data-season="all">ì „ì²´</button>
  </div>

  <div class="separator"></div>

  <label for="playerSelect">í”Œë ˆì´ì–´ :</label>
  <select id="playerSelect"></select>

  <div class="separator"></div>
  
  <h2>ìµœê·¼ ìˆœìœ„</h2>
  <!-- ê·¸ë˜í”„ ì»¨í…Œì´ë„ˆ -->
  <div class="graph-container">
    <canvas id="rankChart"></canvas>
  </div>

  <div class="graph-controls">
    <button class="graph-btn" data-count="10">10êµ­</button>
    <button class="graph-btn" data-count="50">50êµ­</button>
    <button class="graph-btn" data-count="100">100êµ­</button>
  </div>
  <div class="separator"></div>
  <h2>ì‹œì¦Œ í†µê³„</h2>
  <!-- í†µê³„ í…Œì´ë¸” -->
  <table id="statsTable">
    <thead>
      <tr><th>í•­ëª©</th><th>ê°’</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="separator"></div>
  <!-- ì—­ ë‹¬ì„± ë‚´ì—­ -->
  <h2>ì—­ ë‹¬ì„± ë‚´ì—­</h2>
  <table id="yakuTable">
    <thead>
      <tr>
        <th>ì—­ ì¢…ë¥˜</th>
        <th>ë‹¬ì„± íšŸìˆ˜</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Chart.js CDN ë¡œë“œ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const display_keys = {
    "games": { label: "ëŒ€êµ­ ìˆ˜", format: "int", category: "ê¸°ë³¸" },
    "total.avg": { label: "í‰ê· ìˆœìœ„", format: "float", category: "ê¸°ë³¸" },
    "total_first_count": { label: "1ìœ„ íšŸìˆ˜", format: "int", category: "ê¸°ë³¸" },
    "total_second_count": { label: "2ìœ„ íšŸìˆ˜", format: "int", category: "ê¸°ë³¸" },
    "total_third_count": { label: "3ìœ„ íšŸìˆ˜", format: "int", category: "ê¸°ë³¸" },
    "total_fourth_count": { label: "4ìœ„ íšŸìˆ˜", format: "int", category: "ê¸°ë³¸" },
    "first_rate": { label: "1ìœ„ìœ¨", format: "percent", category: "ê¸°ë³¸" },
    "second_rate": { label: "2ìœ„ìœ¨", format: "percent", category: "ê¸°ë³¸" },
    "third_rate": { label: "3ìœ„ìœ¨", format: "percent", category: "ê¸°ë³¸" },
    "fourth_rate": { label: "4ìœ„ìœ¨", format: "percent", category: "ê¸°ë³¸" },
    "endScore.avg": { label: "ìµœì¢… ì ìˆ˜ í‰ê· ", format: "int", category: "ê¸°ë³¸" },
    "endScore.max": { label: "ìµœì¢… ì ìˆ˜ ìµœê³ ", format: "int", category: "ê¸°ë³¸" },
    "endScore.min": { label: "ìµœì¢… ì ìˆ˜ ìµœì €", format: "int", category: "ê¸°ë³¸" },
    "minusScore.avg": { label: "í† ë¹„ìœ¨", format: "percent", category: "ê¸°ë³¸" },
    "minusOther.avg": { label: "íƒ€ê°€ ë“¤í†µë¥ ", format: "percent", category: "ê¸°ë³¸" },
    "east.avg": { label: "ë™ ì‹œì‘ í‰ê·  ìˆœìœ„", format: "float", category: "ê¸°ë³¸" },
    "south.avg": { label: "ë‚¨ ì‹œì‘ í‰ê·  ìˆœìœ„", format: "float", category: "ê¸°ë³¸" },
    "west.avg": { label: "ì„œ ì‹œì‘ í‰ê·  ìˆœìœ„", format: "float", category: "ê¸°ë³¸" },
    "north.avg": { label: "ë¶ ì‹œì‘ í‰ê·  ìˆœìœ„", format: "float", category: "ê¸°ë³¸" },
    "dora.avg": { label: "í‰ê·  ì „ì²´ ë„ë¼ê°¯ìˆ˜", format: "float", category: "ë„ë¼" },
    "dora_outer.avg": { label: "í‰ê·  ë„ë¼ê°¯ìˆ˜", format: "float", category: "ë„ë¼" },
    "dora_akai.avg": { label: "í‰ê·  ì ë„ë¼ê°¯ìˆ˜", format: "float", category: "ë„ë¼" },
    "dora_inner.avg": { label: "í‰ê·  ë’·ë„ë¼ê°¯ìˆ˜", format: "float", category: "ë„ë¼" },
    "dora.per": { label: "ì „ì²´ ë„ë¼ìœ¨", format: "percent", category: "ë„ë¼" },
    "dora_outer.per": { label: "ì¼ë°˜ ë„ë¼ìœ¨", format: "percent", category: "ë„ë¼" },
    "dora_akai.per": { label: "ì ë„ë¼ìœ¨", format: "percent", category: "ë„ë¼" },
    "dora_inner.per": { label: "ë’·ë„ë¼ìœ¨", format: "percent", category: "ë„ë¼" },
    "dora.max": { label: "ìµœëŒ€ ì „ì²´ ë„ë¼ê°¯ìˆ˜", format: "int", category: "ë„ë¼" },
    "dora_outer.max": { label: "ìµœëŒ€ ë„ë¼ê°¯ìˆ˜", format: "int", category: "ë„ë¼" },
    "dora_akai.max": { label: "ìµœëŒ€ ì ë„ë¼ê°¯ìˆ˜", format: "int", category: "ë„ë¼" },
    "dora_inner.max": { label: "ìµœëŒ€ ë’·ë„ë¼ê°¯ìˆ˜", format: "int", category: "ë„ë¼" },
    "dora_inner_eff.avg": { label: "ë’·ë„ë¼ í‰ê·  ë³€í™”ì ", format: "int", category: "ë„ë¼" },
    "dora_inner_eff.per": { label: "ë’·ë„ë¼ ìœ íš¨ìœ¨", format: "percent", category: "ë„ë¼" },
    "dora_inner_eff.max": { label: "ë’·ë„ë¼ ìµœëŒ€ ë³€í™”ì ", format: "int", category: "ë„ë¼" },
    "winGame.avg": { label: "í™”ë£Œìœ¨", format: "percent", category: "í™”ë£Œ ë° ë°©ì´" },
    "winGame_score.avg": { label: "í‰ê·  íƒ€ì ", format: "int", category: "í™”ë£Œ ë° ë°©ì´" },
    "winGame_host.per": { label: "ì˜¤ì•¼ í™”ë£Œìœ¨", format: "percent", category: "í™”ë£Œ ë° ë°©ì´" },
    "winGame_zimo.per": { label: "ì¯”ëª¨ìœ¨", format: "percent", category: "í™”ë£Œ ë° ë°©ì´" },
    "winGame_dama.per": { label: "ë‹¤ë§ˆìœ¨", format: "percent", category: "í™”ë£Œ ë° ë°©ì´" },
    "winGame_round.avg": { label: "í‰ê·  í™”ë£Œ ìˆœìˆ˜", format: "float", category: "í™”ë£Œ ë° ë°©ì´" },
    "chong.avg": { label: "ë°©ì´ë¥ ", format: "percent", category: "í™”ë£Œ ë° ë°©ì´" },
    "chong_score.avg": { label: "í‰ê·  ë°©ì´", format: "int", category: "í™”ë£Œ ë° ë°©ì´" },
    "chong_host.per": { label: "ë°©ì´ì‹œ ì˜¤ì•¼ìœ¨", format: "percent", category: "í™”ë£Œ ë° ë°©ì´" },
    "chong_fulu.per": { label: "ë°©ì´ì‹œ í›„ë¡œìœ¨", format: "percent", category: "í™”ë£Œ ë° ë°©ì´" },
    "chong_richi.per": { label: "ë°©ì´ì‹œ ë¦¬ì¹˜ìœ¨", format: "percent", category: "í™”ë£Œ ë° ë°©ì´" },
    "dehost.avg": { label: "ì˜¤ì•¼ì¹´ë¶€ë¦¬ìœ¨", format: "percent", category: "í™”ë£Œ ë° ë°©ì´" },
    "dehost_score.avg": { label: "ì˜¤ì•¼ì¹´ë¶€ë¦¬ í‰ê· ", format: "int", category: "í™”ë£Œ ë° ë°©ì´" },
    "otherZimo.avg": { label: "í”¼ì¯”ëª¨ìœ¨", format: "percent", category: "í™”ë£Œ ë° ë°©ì´" },
    "richi.avg": { label: "ë¦¬ì¹˜ìœ¨", format: "percent", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" },
    "richi_winGame.per": { label: "ë¦¬ì¹˜ ì„±ê³µë¥ ", format: "percent", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" },
    "richi_score.avg": { label: "ë¦¬ì¹˜ ìˆ˜ì§€", format: "int", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" },
    "richi_yifa.per": { label: "ì¼ë°œë¥ ", format: "percent", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" },
    "richi_rong.per": { label: "ë¦¬ì¹˜ì‹œ ë¡ ë¥ ", format: "percent", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" },
    "richi_zimo.per": { label: "ë¦¬ì¹˜ì‹œ ì¯”ëª¨ìœ¨", format: "percent", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" },
    "richi_chong.per": { label: "ë¦¬ì¹˜ì‹œ ë°©ì´ë¥ ", format: "percent", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" },
    "richi_draw.per": { label: "ë¦¬ì¹˜ì‹œ ìœ êµ­ë¥ ", format: "percent", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" },
    "richi_otherZimo.per": { label: "ë¦¬ì¹˜ì‹œ íƒ€ê°€ ì¯”ëª¨ìœ¨", format: "percent", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" },
    "richi_machi.per": { label: "ë¦¬ì¹˜ ë‹¤ë©´ìœ¨", format: "percent", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" },
    "richi_first.per": { label: "ë¦¬ì¹˜ ì„ ì œìœ¨", format: "percent", category: "ë¦¬ì¹˜ ë° í›„ë¡œ"  },
    "fulu.avg": { label: "í›„ë¡œìœ¨", format: "percent", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" },
    "fulu_score.avg": { label: "í›„ë¡œ ìˆ˜ì§€", format: "int", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" },
    "fulu_zimo.per": { label: "í›„ë¡œì‹œ ì¯”ëª¨ìœ¨", format: "percent", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" },
    "fulu_rong.per": { label: "í›„ë¡œì‹œ ë¡ ìœ¨", format: "percent", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" },
    "fulu_chong.per": { label: "í›„ë¡œì‹œ ë°©ì´ë¥ ", format: "percent", category: "ë¦¬ì¹˜ ë° í›„ë¡œ" }
    };

    const yaku_name_map = {
        "ç«‹ç›´" : "ë¦¬ì¹˜",
        "ä¸¡ç«‹ç›´" : "ë”ë¸”ë¦¬ì¹˜",
        "é–€å‰æ¸…è‡ªæ‘¸å’Œ" : "ë©˜ì  ì¯”ëª¨",
        "å¶ºä¸Šé–‹èŠ±" : "ì˜ìƒê°œí™”",
        "æµ·åº•æ‘¸æœˆ" : "í•´ì €ë¡œì›”",
        "æ²³åº•æ’ˆé­š" : "í•˜ì €ë¡œì–´",
        "ä¸€ç™º" : "ì¼ë°œ",
        "ãƒ‰ãƒ©" : "ë„ë¼",
        "èµ¤ãƒ‰ãƒ©" : "ì ë„ë¼",
        "è£ãƒ‰ãƒ©" : "ë’·ë„ë¼",
        "å¹³å’Œ" : "í•‘í›„",
        "æ–­å¹ºä¹" : "íƒ•ì•¼ì˜¤",
        "ä¸€æ°—é€šè²«" : "ì¼ê¸°í†µê´€",
        "ä¸€ç›ƒå£" : "ì´í˜ì½”",
        "äºŒç›ƒå£	" : "ëŸ‰í˜ì½”",
        "ä¸‰è‰²åŒé †" : "ì‚¼ìƒ‰ë™ìˆœ",
        "ä¸‰è‰²åŒåˆ»" : "ì‚¼ìƒ‰ë™ê°",
        "æ··å…¨å¸¯å¹ºä¹" : "ì°¬íƒ€",
        "ç´”å…¨å¸¯å¹ºä¹	" : "ì¤€ì°¬íƒ€",
        "æ··è€é ­	" : "í˜¼ë…¸ë‘",
        "æ··ä¸€è‰²" : "í˜¼ì¼ìƒ‰",
        "æ¸…ä¸€è‰²" : "ì²­ì¼ìƒ‰",
        "ä¸ƒå¯¾å­" : "ì¹˜ë˜ì´ì¸ ",
        "å¯¾ã€…å’Œ" : "ë˜ì´ë˜ì´",
        "ä¸‰æš—åˆ»" : "ì‚°ì•ˆì»¤",
        "è‡ªé¢¨ æ±" : "ìí’ ë™",
        "è‡ªé¢¨ å—" : "ìí’ ë‚¨",
        "è‡ªé¢¨ è¥¿" : "ìí’ ì„œ",
        "è‡ªé¢¨ åŒ—" : "ìí’ ë¶",
        "å ´é¢¨ æ±" : "ì¥í’ ë™",
        "å ´é¢¨ å—" : "ì¥í’ ë‚¨",
        "å½¹ç‰Œ ç™½" : "ì—­íŒ¨ ë°±",
        "å½¹ç‰Œ ç™¼" : "ì—­íŒ¨ ë°œ",
        "å½¹ç‰Œ ä¸­" : "ì—­íŒ¨ ì¤‘",
        "å°ä¸‰å…ƒ" : "ì†Œì‚¼ì›",
        "æ§æ§“" : "ì°½ê¹¡",
        "ä¸‰æ å­" : "ì‚°ê¹¡ì¦ˆ",
        "æµã—æº€è²«" : "ìœ êµ­ ë§Œê´€",
        "æ•°ãˆå½¹æº€" : "í—¤ì•„ë¦¼ ì—­ë§Œ",
        "å¤©å’Œ" : "ì²œí™”",
        "åœ°å’Œ" : "ì§€í™”",
        "å›½å£«ç„¡åŒ" : "êµ­ì‚¬ë¬´ìŒ",
        "å››æš—åˆ»" : "ìŠ¤ì•ˆì»¤",
        "å¤§ä¸‰å…ƒ" : "ëŒ€ì‚¼ì›",
        "å°å››å–œ" : "ì†Œì‚¬í¬",
        "å­—ä¸€è‰²" : "ìì¼ìƒ‰",
        "ç·‘ä¸€è‰²" : "ë…¹ì¼ìƒ‰",
        "æ¸…è€é ­	" : "ì²­ë…¸ë‘",
        "ä¹è“®å®ç‡ˆ" : "êµ¬ë ¨ë³´ë“±",
        "å›½å£«ç„¡åŒåä¸‰é¢å¾…ã¡" : "êµ­ì‚¬ë¬´ìŒ 13ë©´ ëŒ€ê¸°",
        "å››æš—åˆ»å˜é¨" : "ìŠ¤ì•ˆì»¤ ë‹¨ê¸°",
        "å¤§å››å–œ" : "ëŒ€ì‚¬í¬",
        "ç´”æ­£ä¹è²å®ç¯" : "ìˆœì •êµ¬ë ¨ë³´ë“±"
    };
document.addEventListener("DOMContentLoaded", () => {
  // í…œí”Œë¦¿ ë³€ìˆ˜ë¡œ ì „ë‹¬ëœ ê¸°ë³¸ player_name (ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)
  const defaultPlayer = "{{ player_name | default('', true) }}";
  let currentPlayer = defaultPlayer;
  // ê¸°ì¡´ì— ì „ë‹¬ëœ season (ê¸°ë³¸ ì„ íƒëœ ì‹œì¦Œ) í…œí”Œë¦¿ ë³€ìˆ˜ëŠ” stats.htmlì˜ 'season'
  let currentSeason = "{{ season }}";
  let currentCount = 10; // ê¸°ë³¸ì ìœ¼ë¡œ 10ê°œì˜ ê²Œì„ ë°ì´í„°ë¥¼ ì‚¬ìš©

  // ê·¸ë˜í”„ ì°¨íŠ¸ ê°ì²´
  let rankChart = null;

  // í•¨ìˆ˜: ê·¸ë˜í”„ ê·¸ë¦¬ê¸° ë˜ëŠ” ì—…ë°ì´íŠ¸ (Chart.js ì‚¬ìš©)
  function drawChart(rankData) {
  const ctx = document.getElementById('rankChart').getContext('2d');
  // xì¶•ì€ ë‹¨ìˆœ ì¸ë±ìŠ¤ë¡œ ì²˜ë¦¬
  const labels = rankData.map((_, index) => index + 1);
  if (rankChart) {
    rankChart.data.labels = labels;
    rankChart.data.datasets[0].data = rankData;
    rankChart.update();
  } else {
    rankChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels, // xì¶• ë ˆì´ë¸”ì€ ë³´ì´ì§€ ì•ŠìŒ
        datasets: [{
          data: rankData,
          borderColor: '#3498db',
          backgroundColor: 'rgba(52, 152, 219, 0.2)',
          fill: false,
          tension: 0, // ì§ì„  ì—°ê²°
          pointStyle: 'circle',
          pointRadius: 4,
          pointBackgroundColor: '#3498db'
        }]
      },
      options: {
        // ë°˜ì‘í˜•ìœ¼ë¡œ ìº”ë²„ìŠ¤ê°€ ë¶€ëª¨ ì»¨í…Œì´ë„ˆì˜ ì‚¬ì´ì¦ˆë¥¼ ë”°ë¥¸ë‹¤.
        responsive: true,
        maintainAspectRatio: false,  
        scales: {
          x: {
            display: false // xì¶• ë¼ë²¨ì€ ìˆ¨ê¹€
          },
          y: {
            // yì¶•ì„ ì—­ìˆœìœ¼ë¡œ í•´ì„œ 1ì´ ìƒë‹¨ì— ì˜¤ë„ë¡ ì„¤ì •
            reverse: true,
            ticks: {
              stepSize: 1,
              // ì¶”ê°€ ì—¬ë°±ì„ ì£¼ê¸° ìœ„í•´ ì•½ê°„ì˜ íŒ¨ë”©ì„ í¬í•¨(ì›í•˜ëŠ” ê²½ìš°)
              // callback: (value) => value  // ê¸°ë³¸ ê·¸ëŒ€ë¡œ
            },
            // yì¶• ë²”ìœ„ì— ì—¬ìœ ë¥¼ ì£¼ì–´ ì„ ì´ í…Œë‘ë¦¬ì™€ ë¶™ì§€ ì•Šë„ë¡ ì„¤ì •
            suggestedMin: 1,
            suggestedMax: 4
          }
        },
        plugins: {
          legend: {
            display: false
          }
        },
        layout: {
          // ìº”ë²„ìŠ¤ ë‚´ë¶€ì˜ ë ˆì´ì•„ì›ƒ íŒ¨ë”©ì„ ë¯¸ì„¸ ì¡°ì •
          padding: {
            top: 0,
            bottom: 0,
            left: 0,
            right: 0
          }
        }
      }
    });

  }
}

  // ê·¸ë˜í”„ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ì´ë²¤íŠ¸
  const graphBtns = document.querySelectorAll(".graph-btn");
  graphBtns.forEach(btn => {
    btn.addEventListener("click", function(){
      currentCount = parseInt(this.getAttribute("data-count"));
      loadStats(currentPlayer);
    });
  });

  // ì‹œì¦Œ íƒ­ ì´ë²¤íŠ¸
  const tabs = document.querySelectorAll(".season-tabs .tab");
  tabs.forEach(tab => {
    tab.addEventListener("click", function(){
      tabs.forEach(t => t.classList.remove("active"));
      this.classList.add("active");
      currentSeason = this.getAttribute("data-season");
      loadStats(currentPlayer);
    });
  });

  function showLoading() {
    const loadingElem = document.getElementById("loading");
    if (loadingElem) {
      loadingElem.style.display = "flex";
    }
  }
  function hideLoading() {
    const loadingElem = document.getElementById("loading");
    if (loadingElem) {
      loadingElem.style.display = "none";
    }
  }

  // í†µê³„ ë°ì´í„° ë Œë”ë§ í•¨ìˆ˜ (í…Œì´ë¸”ê³¼ yakus)
  function renderTable(stats) {
    const tbody = document.querySelector("#statsTable tbody");
    tbody.innerHTML = "";
    const totalGames = stats.games || 0;
    if (totalGames > 0) {
      stats.first_rate = stats.total_first_count / totalGames;
      stats.second_rate = stats.total_second_count / totalGames;
      stats.third_rate = stats.total_third_count / totalGames;
      stats.fourth_rate = stats.total_fourth_count / totalGames;
    }
    let currentCategory = "";
    for (const [key, { label, format, category }] of Object.entries(display_keys)) {
      const value = key.split('.').reduce((o, i) => (o ? o[i] : undefined), stats);
      if (value !== undefined) {
        if (category && category !== currentCategory) {
          const headerRow = document.createElement("tr");
          const headerCell = document.createElement("td");
          headerCell.colSpan = 2;
          headerCell.className = "category-header";
          headerCell.textContent = category;
          headerRow.appendChild(headerCell);
          tbody.appendChild(headerRow);
          currentCategory = category;
        }
        const row = document.createElement("tr");
        let formattedValue = "";
        if (typeof value === "number") {
          switch (format) {
            case "int": formattedValue = Math.floor(value).toLocaleString(); break;
            case "float": formattedValue = value.toFixed(2); break;
            case "percent": formattedValue = (value * 100).toFixed(2) + "%"; break;
            default: formattedValue = value;
          }
        } else {
          formattedValue = value;
        }
        row.innerHTML = `<td>${label}</td><td>${formattedValue}</td>`;
        tbody.appendChild(row);
      }
    }
  }

  function renderYakus(yakusArray) {
    const yakuTableBody = document.querySelector("#yakuTable tbody");
    yakuTableBody.innerHTML = "";
    if (!yakusArray || !Array.isArray(yakusArray)) {
      yakuTableBody.innerHTML = "<tr><td colspan='2'>ë°ì´í„° ì—†ìŒ</td></tr>";
      return;
    }
    const yakusMap = Object.fromEntries(yakusArray.map(([count, name]) => [name.trim(), count]));
    const sortedYakus = Object.keys(yaku_name_map).map(name => [yakusMap[name] || 0, name]);
    sortedYakus.forEach(([count, yaku]) => {
      const row = document.createElement("tr");
      const nameCell = document.createElement("td");
      const countCell = document.createElement("td");
      nameCell.textContent = yaku_name_map[yaku] || yaku;
      countCell.textContent = count.toLocaleString();
      row.appendChild(nameCell);
      row.appendChild(countCell);
      yakuTableBody.appendChild(row);
    });
  }

  // loadStats: í”Œë ˆì´ì–´ë³„ í†µê³„ ë°ì´í„°ë¥¼ JSON APIì—ì„œ ë¶ˆëŸ¬ì™€ ê·¸ë˜í”„ì™€ í…Œì´ë¸” ê°±ì‹ 
  function loadStats(player) {
    showLoading();
    currentPlayer = player;
    // API ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ ì‹œ "count" íŒŒë¼ë¯¸í„° í¬í•¨
    fetch(`/stats_api/${player}?season=${currentSeason}&count=${currentCount}`)
      .then((res) => res.json())
      .then((data) => {
        console.log("rankData:", data.rankData);  // rankData ì¶œë ¥ í™•ì¸
        const stats = data.stats || data.data;
        if (!stats) return;
        renderTable(stats);
        renderYakus(stats.yakus);
        if (stats.rankData && stats.rankData.length > 0) {
          drawChart(stats.rankData);
        } else {
          console.warn("rankData is empty or undefined.");
        }
      })
      .catch(error => console.error("Error loading stats:", error))
      .finally(() => hideLoading());     
  }

  // í”Œë ˆì´ì–´ ì½¤ë³´ë°•ìŠ¤ ì²˜ë¦¬
  const playerSelect = document.getElementById("playerSelect");
  if (playerSelect) {
    playerSelect.innerHTML = "";
    fetch("/stats/all")
      .then((res) => res.json())
      .then((data) => {
        data.allPlayers.forEach((player) => {
          const option = document.createElement("option");
          option.value = player;
          option.textContent = player;
          playerSelect.appendChild(option);
        });
        if (data.allPlayers.length > 0) {
          if (defaultPlayer && data.allPlayers.includes(defaultPlayer)) {
            playerSelect.value = defaultPlayer;
            currentPlayer = defaultPlayer;
          } else {
            playerSelect.value = data.allPlayers[0];
            currentPlayer = data.allPlayers[0];
          }
          loadStats(currentPlayer);
        }
      });
    playerSelect.addEventListener("change", () => {
      currentPlayer = playerSelect.value;
      loadStats(currentPlayer);
    });
  } else {
    console.error("playerSelect ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  }
});
</script>

{% endblock %}
